---
title: Vagrantfile
date: 2023-06-09 00:02:44
permalink: /pages/d41b56/
categories:
  - è™šæ‹ŸåŒ–
  - è™šæ‹ŸåŒ–
  - Vagrant
tags:
  - 
author: 
  name: MeiChen
  link: https://github.com/mtl-123
---

## Vagrantfile æ¨¡æ¿ç¼–å†™
> ä½¿ç”¨Vagrantfile æ‰¹é‡åˆ›å»ºè™šæ‹Ÿæœº

### å†™æ³•ä¸€
```ruby
# vi: set ft=ruby :

servers = [
    {
        :name => "gitlab",
        :type => "gitlab",
        :box => "ubuntu/focal64",
        :box_version => "20221021.0.0",
        :eth1 => "10.0.0.20",
        :mem => "2048",
        :cpu => "2"
    },
    {
        :name => "jenkins",
        :type => "jenkins",
        :box => "ubuntu/focal64",
        :box_version => "20221021.0.0",
        :eth1 => "10.0.0.21",
        :mem => "2048",
        :cpu => "2"
    },
    {
        :name => "Blog",
        :type => "Blog",
        :box => "ubuntu/focal64",
        :box_version => "20221021.0.0",
        :eth1 => "10.0.0.30",
        :mem => "4096",
        :cpu => "2"
    }
]

ENV["LC_ALL"] = "en_US.UTF-8"
#æŒ‡å®švmçš„è¯­è¨€ç¯å¢ƒï¼Œç¼ºçœåœ°ï¼Œä¼šç»§æ‰¿hostçš„localeé…ç½®

# è·å–é»˜è®¤æ¥å£çš„åç§°
$default_network_interface = `ip route | awk '/^default/ {printf "%s", $5; exit 0}'`

Vagrant.configure("2") do |config|
    servers.each do |opts|
        config.vm.define opts[:name] do |config|
            config.vm.box = opts[:box]
            config.vm.box_version = opts[:box_version]
            config.vm.hostname = opts[:name]
            config.vm.network "public_network",  bridge: "#$default_network_interface",  ip: opts[:eth1]
            config.vm.provider "virtualbox" do |v|
                v.name = opts[:name]
                v.customize ["modifyvm", :id, "--groups", "/DevOps-Blog Environment"]
                v.customize ["modifyvm", :id, "--memory", opts[:mem]]
            # è‡ªå®šä¹‰ç”¨æˆ·åå’Œå¯†ç 
            # # 'echo "vagrant:1"   è¿™é‡Œçš„ "vagrantç”¨æˆ·æ˜¯é»˜è®¤åˆ›å»ºçš„ä¸å¯æ›´æ”¹:1 æ˜¯å¯†ç å¯æ›´æ”¹çš„"
            config.vm.provision 'shell', inline: 'echo "vagrant:a" | chpasswd'
            config.vm.provision "shell", inline: <<-SHELL
            echo "å¼€å¯rootç™»å½•"
            echo "PermitRootLogin yes" >> /etc/ssh/sshd_config
            # echo "å¼€å¯è¿œç¨‹ç™»å½•"         
            sed -in 's/PasswordAuthentication no/PasswordAuthentication yes/g' /etc/ssh/sshd_config
            echo "é‡å¯SSHæœåŠ¡"
            systemctl restart sshd.service
            echo "å®‰è£… git vim curl å·¥å…·"
            apt-get install vim git curl -y
            echo "å®‰è£…æˆåŠŸ ğŸ’¯ğŸ’¯ğŸ’¯"            
            SHELL
            end
        end
    end
end
```

### å†™æ³•äºŒ
```ruby
Vagrant.configure("2") do | config|
 (1..3).each do |i|
  config.vm.define "k8s-node#{i}" do |node|
   # è®¾ç½®è™šæ‹Ÿæœºçš„Box
   node.vm.box = "centos/7"

   # è®¾ç½®è™šæ‹Ÿæœºçš„ä¸»æœºå
   node.vm.hostname="k8s-node#{i}"

   # è®¾ç½®è™šæ‹Ÿæœºçš„IP
   node.vm.network "private_network", ip: "192.168.56.#{99+i}", netmask: "255.255.255.0"

   # è®¾ç½®ä¸»æœºä¸è™šæ‹Ÿæœºçš„å…±äº«ç›®å½•
   # node.vm.synced_folder "~/Documents/vagrant/share", "/home/vagrant/share"

   # VirtaulBoxç›¸å…³é…ç½®
   node.vm.provider "virtualbox" do |v|
    # è®¾ç½®è™šæ‹Ÿæœºçš„åç§°
    v.name = "k8s-node#{i}"
    # è®¾ç½®è™šæ‹Ÿæœºçš„å†…å­˜å¤§å°
    v.memory= 4096
    # è®¾ç½®è™šæ‹Ÿæœºçš„CPUä¸ªæ•°
    v.cpus = 4
   end
  end
 end
end
```

### åˆ›å»ºk8sé›†ç¾¤
```ruby
# -*- mode: ruby -*-
# vi: set ft=ruby :

servers = [
    {
        :name => "k8s-head",
        :type => "master",
        :box => "ubuntu/focal64",
        :box_version => "20221021.0.0",
        :eth1 => "192.168.56.20",
        :mem => "2048",
        :cpu => "2"
    },
    {
        :name => "k8s-node-1",
        :type => "node",
        :box => "ubuntu/focal64",
        :box_version => "20221021.0.0",
        :eth1 => "192.168.56.21",
        :mem => "2048",
        :cpu => "2"
    },
    {
        :name => "k8s-node-2",
        :type => "node",
        :box => "ubuntu/focal64",
        :box_version => "20221021.0.0",
        :eth1 => "192.168.56.22",
        :mem => "2048",
        :cpu => "2"
    }
]

ENV["LC_ALL"] = "en_US.UTF-8"
#æŒ‡å®švmçš„è¯­è¨€ç¯å¢ƒï¼Œç¼ºçœåœ°ï¼Œä¼šç»§æ‰¿hostçš„localeé…ç½®

# è·å–é»˜è®¤æ¥å£çš„åç§°
$default_network_interface = `ip route | awk '/^default/ {printf "%s", $5; exit 0}'`

# This script to install k8s using kubeadm will get executed after a box is provisioned
$configureBox = <<-SCRIPT

    # æ›´æ¢å›½å†…aptæº
    cp /etc/apt/sources.list /etc/apt/sources_init.list
    tee > /etc/apt/sources.list <<EOF
    deb https://mirrors.ustc.edu.cn/ubuntu/ focal main restricted universe multiverse
    deb-src https://mirrors.ustc.edu.cn/ubuntu/ focal main restricted universe multiverse
    deb https://mirrors.ustc.edu.cn/ubuntu/ focal-security main restricted universe multiverse
    deb-src https://mirrors.ustc.edu.cn/ubuntu/ focal-security main restricted universe multiverse
    deb https://mirrors.ustc.edu.cn/ubuntu/ focal-updates main restricted universe multiverse
    deb-src https://mirrors.ustc.edu.cn/ubuntu/ focal-updates main restricted universe multiverse
    deb https://mirrors.ustc.edu.cn/ubuntu/ focal-backports main restricted universe multiverse
    deb-src https://mirrors.ustc.edu.cn/ubuntu/ focal-backports main restricted universe multiverse
    ## Not recommended
    # deb https://mirrors.ustc.edu.cn/ubuntu/ focal-proposed main restricted universe multiverse
    # deb-src https://mirrors.ustc.edu.cn/ubuntu/ focal-proposed main restricted universe multiverse
EOF
    # install docker v19.03.10
    # reason for not using docker provision is that it always installs latest version of the docker, but kubeadm requires 17.03 or older
    apt-get update 

    apt-get install \
    ca-certificates \
    curl \
    gnupg \
    apt-transport-https \
    software-properties-common \
    lsb-release -y

    sudo mkdir -p /etc/apt/keyrings
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
    
    # 3. è®¾ç½®å­˜å‚¨åº“
    echo \
      "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
      $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
    # install docker-19.03.10 
    apt-get update && apt-get install -y docker-ce=$(apt-cache madison docker-ce | grep 19.03.10 | head -1 | awk '{print $3}')

    # run docker commands as vagrant user (sudo not required)
    usermod -aG docker vagrant
    mkdir -p /etc/docker

    tee <<EOF >/etc/docker/daemon.json
    {
      "exec-opts":["native.cgroupdriver=systemd"],
    
      "registry-mirrors": [
        "https://dockerhub.azk8s.cn",
        "https://reg-mirror.qiniu.com"
      ]
    }
EOF
    # åŠ è½½
    sudo systemctl daemon-reload
    # é‡å¯
    sudo systemctl restart docker
    # è®¾ç½®è‡ªå¯åŠ¨
    sudo systemctl enable docker

    # install kubeadm
    apt-get install -y apt-transport-https curl
    curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add -

    cat <<EOF >/etc/apt/sources.list.d/kubernetes.list
    deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main
EOF
    
    apt-get update
    apt-get install -y kubelet=1.18.5-00 kubeadm=1.18.5-00 kubectl=1.18.5-00
    apt-mark hold kubelet kubeadm kubectl

    # kubelet requires swap off
    swapoff -a

    # keep swap off after reboot
    sudo sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab

    # ip of this box
    IP_ADDR=`ifconfig enp0s8 | grep Mask | awk '{print $2}'| cut -f2 -d:`
    # set node-ip
    sudo sed -i "/^[^#]*KUBELET_EXTRA_ARGS=/c\KUBELET_EXTRA_ARGS=--node-ip=$IP_ADDR" /etc/default/kubelet
    sudo systemctl enable --now kubelet
SCRIPT

$configureMaster = <<-SCRIPT
    # æ›´æ¢å›½å†…aptæº
    cp /etc/apt/sources.list /etc/apt/sources_init.list
    tee > /etc/apt/sources.list <<EOF
    deb https://mirrors.ustc.edu.cn/ubuntu/ focal main restricted universe multiverse
    deb-src https://mirrors.ustc.edu.cn/ubuntu/ focal main restricted universe multiverse
    deb https://mirrors.ustc.edu.cn/ubuntu/ focal-security main restricted universe multiverse
    deb-src https://mirrors.ustc.edu.cn/ubuntu/ focal-security main restricted universe multiverse
    deb https://mirrors.ustc.edu.cn/ubuntu/ focal-updates main restricted universe multiverse
    deb-src https://mirrors.ustc.edu.cn/ubuntu/ focal-updates main restricted universe multiverse
    deb https://mirrors.ustc.edu.cn/ubuntu/ focal-backports main restricted universe multiverse
    deb-src https://mirrors.ustc.edu.cn/ubuntu/ focal-backports main restricted universe multiverse
    ## Not recommended
    # deb https://mirrors.ustc.edu.cn/ubuntu/ focal-proposed main restricted universe multiverse
    # deb-src https://mirrors.ustc.edu.cn/ubuntu/ focal-proposed main restricted universe multiverse
EOF

    echo "This is master"
    # ip of this box
    IP_ADDR=`ifconfig  enp0s8 | grep mask |  awk '{print $2}'| cut -f2 -d:`

    # install k8s master
    HOST_NAME=$(hostname -s)
    # sudo kubeadm  init --config kubeadm-config.yaml   
    kubeadm init --apiserver-advertise-address=$IP_ADDR --apiserver-cert-extra-sans=$IP_ADDR  --node-name $HOST_NAME --pod-network-cidr=192.168.0.0/16

    #copying credentials to regular user - vagrant
    sudo --user=vagrant mkdir -p /home/vagrant/.kube
    cp -i /etc/kubernetes/admin.conf /home/vagrant/.kube/config
    chown $(id -u vagrant):$(id -g vagrant) /home/vagrant/.kube/config

    # install Calico pod network addon
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl apply -f https://docs.projectcalico.org/v3.1/getting-started/kubernetes/installation/hosted/rbac-kdd.yaml
    kubectl apply -f https://docs.projectcalico.org/v3.1/getting-started/kubernetes/installation/hosted/kubernetes-datastore/calico-networking/1.7/calico.yaml

    kubeadm token create --print-join-command >> /etc/kubeadm_join_cmd.sh
    chmod +x /etc/kubeadm_join_cmd.sh

    # required for setting up password less ssh between guest VMs
    sudo sed -i "/^[^#]*PasswordAuthentication[[:space:]]no/c\PasswordAuthentication yes" /etc/ssh/sshd_config
    sudo service sshd restart

SCRIPT

$configureNode = <<-SCRIPT
    echo "This is worker"
    apt-get install -y sshpass
    sshpass -p "vagrant" scp -o StrictHostKeyChecking=no vagrant@192.168.56.20:/etc/kubeadm_join_cmd.sh .
    sh ./kubeadm_join_cmd.sh
SCRIPT

Vagrant.configure("2") do |config|
    servers.each do |opts|
        config.vm.define opts[:name] do |config|
            config.vm.box = opts[:box]
            config.vm.box_version = opts[:box_version]
            config.vm.hostname = opts[:name]
            config.vm.network "public_network",  bridge: "#$default_network_interface",  ip: opts[:eth1]
            config.vm.provider "virtualbox" do |v|
                v.name = opts[:name]
            	v.customize ["modifyvm", :id, "--groups", "/Ballerina Development"]
                v.customize ["modifyvm", :id, "--memory", opts[:mem]]
                v.customize ["modifyvm", :id, "--cpus", opts[:cpu]]
            end

            # we cannot use this because we can't install the docker version we want - https://github.com/hashicorp/vagrant/issues/4871
            #config.vm.provision "docker"

            config.vm.provision "shell", inline: $configureBox
            if opts[:type] == "master"
                config.vm.provision "shell", inline: $configureMaster
            else
                config.vm.provision "shell", inline: $configureNode
            end
        end
    end
end

```
### è¿œç¨‹è„šæœ¬å®‰è£…K8s
```ruby
# -*- mode: ruby -*-
# vi: set ft=ruby :

ENV["LC_ALL"] = "en_US.UTF-8"
#æŒ‡å®švmçš„è¯­è¨€ç¯å¢ƒï¼Œç¼ºçœåœ°ï¼Œä¼šç»§æ‰¿hostçš„localeé…ç½®

Vagrant.configure("2") do |config|
  config.vm.define "master" do |dev|
  config.vm.box = "gbailey/amzn2"
  config.vm.box_version = "20221023.0.0"
  dev.vm.provider "virtualbox" do |v|
    v.memory= 4096
    v.cpus = 2
    
  config.vm.provision "B", type: "shell", inline:<<-SHELL
  
  echo -e "\033[33m download scritp file \033[0m"
   wget https://raw.githubusercontent.com/mtl-123/kubernetes/mei/script/install_ctr_k8s.sh
  echo -e "\033[31m Add executable permissions \033[0m"
  chmod +x install_ctr_k8s.sh
  echo "================================== start install k8s ============================================= "
  sudo ./install_ctr_k8s.sh

  echo -e "\033[32m Kubernetes install successful \033[0m"
  
  SHELL
  end
end
end
```
### å¼€å‘ç¯å¢ƒ
```ruby
# vi: set ft=ruby :

servers = [
  {
      :name => "Python-Dev",
      :type => "master",
    #   :box => "generic/centos7",
    #   :box_version => "4.2.6",
      :box => "ubuntu/focal64",
      :box_version => "20221021.0.0",
      :eth1 => "192.168.56.100",
      :mem => "4094",
      :cpu => "2"
  },
  {
      :name => "Shell-Dev",
      :type => "node",
    #   :box => "generic/centos7",
    #   :box_version => "4.2.6",
      :box => "ubuntu/focal64",
      :box_version => "20221021.0.0",
      :eth1 => "192.168.56.110",
      :mem => "4094",
      :cpu => "2"
  },
  {
      :name => "GoLang-Dev",
      :type => "node",
    #   :box => "generic/centos7",
    #   :box_version => "4.2.6",
      :box => "ubuntu/focal64",
      :box_version => "20221021.0.0",
      :eth1 => "192.168.56.120",
      :mem => "4094",
      :cpu => "2"
  }
]
# è·å–é»˜è®¤æ¥å£çš„åç§°
$default_network_interface = `ip route | awk '/^default/ {printf "%s", $5; exit 0}'`

$configureBox = <<-SCRIPT
    # æ›´æ¢å›½å†…aptæº
    cp /etc/apt/sources.list /etc/apt/sources_init.list
    # å†™å…¥å›½å†…aptæºé…ç½®
    tee > /etc/apt/sources.list <<EOF
    deb https://mirrors.ustc.edu.cn/ubuntu/ focal main restricted universe multiverse
    deb-src https://mirrors.ustc.edu.cn/ubuntu/ focal main restricted universe multiverse
    deb https://mirrors.ustc.edu.cn/ubuntu/ focal-security main restricted universe multiverse
    deb-src https://mirrors.ustc.edu.cn/ubuntu/ focal-security main restricted universe multiverse
    deb https://mirrors.ustc.edu.cn/ubuntu/ focal-updates main restricted universe multiverse
    deb-src https://mirrors.ustc.edu.cn/ubuntu/ focal-updates main restricted universe multiverse
    deb https://mirrors.ustc.edu.cn/ubuntu/ focal-backports main restricted universe multiverse
    deb-src https://mirrors.ustc.edu.cn/ubuntu/ focal-backports main restricted universe multiverse
    ## Not recommended
    # deb https://mirrors.ustc.edu.cn/ubuntu/ focal-proposed main restricted universe multiverse
    # deb-src https://mirrors.ustc.edu.cn/ubuntu/ focal-proposed main restricted universe multiverse
EOF
    apt update
    apt install -y git vim wget curl python3-pip
    pip3 install --upgrade pip
    mkdir ~/.pip
    touch ~/.pip/pip.conf
    tee > ~/.pip/pip.conf <<EOF
    [global]
    index-url = https://pypi.tuna.tsinghua.edu.cn/simple 
EOF

    pip install --user pdm
    cp -rf /root/.local/bin/* /usr/local/bin/
    pdm self update
    pdm completion bash > /etc/bash_completion.d/pdm.bash-completion

SCRIPT

ENV["LC_ALL"] = "en_US.UTF-8"
#æŒ‡å®švmçš„è¯­è¨€ç¯å¢ƒï¼Œç¼ºçœåœ°ï¼Œä¼šç»§æ‰¿hostçš„localeé…ç½®
Vagrant.configure("2") do |config|
  servers.each do |opts|
      config.vm.define opts[:name] do |config|
          config.vm.box = opts[:box]
          config.vm.box_version = opts[:box_version]
          config.vm.hostname = opts[:name]
          config.vm.network "public_network",  bridge: "#$default_network_interface",  ip: opts[:eth1]
          config.vm.provider "virtualbox" do |vb|
              vb.name = opts[:name]
              vb.customize ["modifyvm", :id, "--groups", "/DevOps Environment"]
              vb.customize ["modifyvm", :id, "--memory", opts[:mem]]
          config.vm.provision "shell", inline: $configureBox
          end
      end
  end
end
```

# æœ€æ–°çš„è„šæœ¬

```ruby
# -*- mode: ruby -*-
# vi: set ft=ruby :

servers = [
    {
        :name => "gitlab",
        :type => "gitlab",
        :box => "ubuntu/focal64",
        :box_version => "20221021.0.0",
        :eth1 => "10.0.0.20",
        :mem => "2048",
        :cpu => "2"
    },
    {
        :name => "jenkins",
        :type => "jenkins",
        :box => "ubuntu/focal64",
        :box_version => "20221021.0.0",
        :eth1 => "10.0.0.21",
        :mem => "2048",
        :cpu => "2"
    },
    {
        :name => "Blog",
        :type => "Blog",
        :box => "ubuntu/focal64",
        :box_version => "20221021.0.0",
        :eth1 => "10.0.0.22",
        :mem => "4096",
        :cpu => "2"
    }
]

ENV["LC_ALL"] = "en_US.UTF-8"
#æŒ‡å®švmçš„è¯­è¨€ç¯å¢ƒï¼Œç¼ºçœåœ°ï¼Œä¼šç»§æ‰¿hostçš„localeé…ç½®

# è·å–é»˜è®¤æ¥å£çš„åç§°
$default_network_interface = `ip route | awk '/^default/ {printf "%s", $5; exit 0}'`

Vagrant.configure("2") do |config|
    servers.each do |opts|
        config.vm.define opts[:name] do |config|
            config.vm.box = opts[:box]
            config.vm.box_version = opts[:box_version]
            config.vm.hostname = opts[:name]
            config.vm.network "public_network",  bridge: "#$default_network_interface",  ip: opts[:eth1]
            config.vm.provider "virtualbox" do |v|
                v.name = opts[:name]
                v.customize ["modifyvm", :id, "--groups", "/DevOps-Blog Environment"]
                v.customize ["modifyvm", :id, "--memory", opts[:mem]]
            # è‡ªå®šä¹‰ç”¨æˆ·åå’Œå¯†ç 
            # Set a default password for the root user
            # ä¸ºæ ¹ç”¨æˆ·è®¾ç½®é»˜è®¤å¯†ç 
            config.vm.provision "shell", inline: "echo 'root:vagrant' | sudo chpasswd"
            config.vm.provision "shell", inline: <<-SHELL

            echo "å¼€å¯rootç™»å½•"
            echo "PermitRootLogin yes" >> /etc/ssh/sshd_config
            # echo "å¼€å¯è¿œç¨‹ç™»å½•"
            sed -in 's/PasswordAuthentication no/PasswordAuthentication yes/g' /etc/ssh/sshd_config           
            echo "é‡å¯SSHæœåŠ¡"
            systemctl restart sshd.service

            echo "å®‰è£… git vim curl å·¥å…·"
            apt-get install vim git curl -y
            echo "å®‰è£…æˆåŠŸ ğŸ’¯ğŸ’¯ğŸ’¯"
            echo "nvmç®¡ç†å·¥å…·"

            sudo bash -c "$(curl -fsSL https://gitee.com/RubyKids/nvm-cn/raw/main/install.sh)"

            # nvm install  v14.17.5

            SHELL
            # Configure SSH settings for all virtual machines
            # ä¸ºæ‰€æœ‰è™šæ‹Ÿæœºé…ç½®SSHè®¾ç½®
            config.ssh.username = "root"
            config.ssh.password = "1"
            config.ssh.insert_key = "true"
            end
        end
    end
end
```
